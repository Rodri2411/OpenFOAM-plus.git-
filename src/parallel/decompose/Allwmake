#!/bin/sh
cd ${0%/*} || exit 1    # Run from this directory

# Parse arguments for library compilation
. $WM_PROJECT_DIR/wmake/scripts/AllwmakeParseArguments

unset METIS_ARCH_PATH SCOTCH_ARCH_PATH

# get METIS_VERSION, METIS_ARCH_PATH
if settings=$($WM_PROJECT_DIR/bin/foamEtcFile config.sh/metis)
then
    . $settings
    echo "using METIS_ARCH_PATH=$METIS_ARCH_PATH"
else
    echo
    echo "Error: no config.sh/metis settings"
    echo
fi

# get SCOTCH_VERSION, SCOTCH_ARCH_PATH
if settings=$($WM_PROJECT_DIR/bin/foamEtcFile config.sh/scotch)
then
    . $settings
    echo "using SCOTCH_ARCH_PATH=$SCOTCH_ARCH_PATH"
else
    echo
    echo "Error: no config.sh/scotch settings"
    echo
fi


#
# define how to create an mpi-versioned library of $targetType
# compile into qualified directory
# use sentinel file to handle version changes
#
wmakeMpiLib()
{
    set +x
    for libName
    do
    (
        WM_OPTIONS="$WM_OPTIONS$WM_MPLIB"
        libDir="$WM_PROJECT_DIR/platforms/$WM_OPTIONS/src/parallel/decompose/$libName"
        whichmpi="$libDir/using:$FOAM_MPI"
        whichscotch="$libDir/using:$SCOTCH_VERSION"
        [ -e "$whichmpi" -a -e "$whichscotch" ] || wclean $libName
        echo "wmake $targetType $libName"
        wmake $targetType $libName
        mkdir -p "$libDir"
        touch "$whichmpi" "$whichscotch"
    )
    done
    set -x
}

set -x

wmakeLnInclude decompositionMethods

if [ -f $SCOTCH_ARCH_PATH/include/scotch.h \
  -a -r $FOAM_EXT_LIBBIN/libscotch.so ]
then
    wmake $targetType scotchDecomp
    if [ -d "$FOAM_LIBBIN/$FOAM_MPI" ]
    then
        wmakeMpiLib ptscotchDecomp
    fi
else
    echo
    echo "Skipping scotchDecomp (ptscotchDecomp)"
    echo
fi


if [ -f $METIS_ARCH_PATH/include/metis.h \
  -a -r $FOAM_EXT_LIBBIN/libmetis.so ]
then
    wmake $targetType metisDecomp
else
    echo
    echo "Skipping metisDecomp: metis not installed"
    echo
fi


wmake $targetType decompositionMethods

wmake $targetType decompose

#------------------------------------------------------------------------------
