#!/bin/sh
cd ${0%/*} || exit 1    # Run from this directory

# Optional unit: continue-on-error
export WM_CONTINUE_ON_ERROR=true

# Parse arguments for library compilation
. $WM_PROJECT_DIR/wmake/scripts/AllwmakeParseArguments

# Source the wmake functions
. $WM_PROJECT_DIR/wmake/scripts/wmakeFunctions

# -----------------------------------------------------------------------------

#
# There are several prerequisites for building plugins
#
#set -x
canBuildPlugin()
{
    [ -d "$ParaView_DIR" -a -r "$ParaView_DIR" ] || {
        echo "==> cannot build ParaView plugins without paraview directory"
        echo "    ParaView_DIR=$ParaView_DIR"
        return 1
    }

    [ -n "$PV_PLUGIN_PATH" ] || {
        echo "==> ${PWD##*/} : invalid PV_PLUGIN_PATH for building ParaView plugins"
        echo "    PV_PLUGIN_PATH=${PV_PLUGIN_PATH:-unset}"
        return 1
    }

    type cmake > /dev/null 2>&1 || {
        echo "==> cannot build ParaView plugins without cmake"
        return 1
    }

    return 0 # success
}


#
# Check sentinel file(s) to handle paraview version changes
#
versionOk()
{
    findObjectDir "$1"  # Where generated files are stored
    local sentinel="$objectsDir/ThirdParty"

    echo $sentinel

    local prev
    if read -r prev 2>/dev/null < $sentinel
    then
        case "$prev" in
        ("ParaView_DIR=$ParaView_DIR")
            return 0
            ;;
        (*)
            echo "ParaView_DIR changed between builds" 1>&2
            return 1
            ;;
        esac
    elif [ -f "$objectsDir/CMakeCache.txt" ]
    then
        echo "previous build was incomplete" 1>&2
        return 1
    else
        return 0
    fi
}


#
# Build library - use sentinel file(s) to handle paraview version changes
#
wmakeLibPv()
{
    for libName
    do
        sentinel=$(versionOk $libName) || wclean $libName  # version changed
        wmake $targetType $libName && {
            echo "ParaView_DIR=$ParaView_DIR" > $sentinel
        }
    done
}


# -----------------------------------------------------------------------------

# major version as per paraview include directory:
# Eg, "PREFIX/include/paraview-5.0" -> "5.0"
major="${ParaView_INCLUDE_DIR##*-}"

case "$major" in
[45].[0-9]*)
    if canBuildPlugin
    then
    (
        wmakeLibPv vtkPVReaders
        PVblockMeshReader/Allwmake $targetType $*
        PVFoamReader/Allwmake $targetType $*

        # Dummy directory to trigger proper 'wclean all' behaviour
        # - the Allwclean will otherwise not be used
        mkdir -p Make
    )
    fi
    ;;
*)
    echo "==> skip build of ParaView plugins"
    echo "    include directory was for paraview major version '${major:-none}'"
    ;;
esac

#------------------------------------------------------------------------------
